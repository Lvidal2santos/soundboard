<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mic Button Recorder Pro</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f7f9;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        #container {
            padding: 20px 15px 120px;
            display: flex;
            flex-wrap: wrap;
            gap: center;
            gap: 18px;
            max-width: 600px;
            margin: 0 auto;
        }

        .action-button {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 26px;
            border: none;
            color: white;
            font-size: 56px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            transition: transform 0.15s;
        }

        .action-button:active { transform: scale(0.92); }

        .recording {
            animation: pulse 1.2s infinite alternate;
        }

        @keyframes pulse {
            from { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
            to { box-shadow: 0 0 0 20px rgba(255,0,0,0); }
        }

        /* BIG RED X — always visible in edit mode */
        .delete-badge {
            position: absolute;
            top: -14px;
            right: -14px;
            width: 52px;
            height: 52px;
            background: #ff3b30;
            border: 5px solid white;
            border-radius: 50%;
            color: white;
            font-size: 32px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 9999;
            pointer-events: auto;
        }

        /* Fixed buttons */
        #fixed-controls {
            position: fixed;
            bottom: 30px;
            right: 24px;
            display: flex;
            gap: 18px;
            z-index: 10000;
        }

        .fab {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 36px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0,0,0,0.35);
            transition: all 0.2s;
        }

        #addButton { background: #34c759; }
        #editButton { background: #ff9500; }
        #editButton.active { background: #5856d6; transform: scale(1.15); }

        /* Modal */
        #modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 420px;
            text-align: center;
        }

        #emoticonInput {
            font-size: 70px;
            height: 110px;
            text-align: center;
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 16px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="container"></div>

    <div id="fixed-controls">
        <button id="editButton" class="fab">Pencil</button>
        <button id="addButton" class="fab">+</button>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2>New Button</h2>
            <p><strong>Color:</strong></p>
            <input type="color" id="colorInput" value="#007aff" style="width:100%;height:60px;border-radius:12px;">

            <p style="margin:25px 0 10px;"><strong>Emoji (tap to pick):</strong></p>
            <input type="text" id="emoticonInput" placeholder="Tap here" value="Microphone" readonly>

            <div style="margin-top:35px;display:flex;gap:15px;">
                <button id="cancelButton" style="flex:1;padding:16px;font-size:18px;border-radius:12px;border:none;background:#ddd;">Cancel</button>
                <button id="saveButton" style="flex:1;padding:16px;font-size:18px;border-radius:12px;border:none;background:#34c759;color:white;">Create</button>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('container');
        const addBtn = document.getElementById('addButton');
        const editBtn = document.getElementById('editButton');
        const modal = document.getElementById('modal');
        const colorInput = document.getElementById('colorInput');
        const emojiInput = document.getElementById('emoticonInput');
        const saveBtn = document.getElementById('saveButton');
        const cancelBtn = document.getElementById('cancelButton');

        let buttons = JSON.parse(localStorage.getItem('soundboardButtons') || '[]');
        let editMode = false;
        let holdTimer, recorder, chunks = [];

        // EDIT MODE — now impossible to miss
        editBtn.onclick = () => {
            editMode = !editMode;
            editBtn.classList.toggle('active', editMode);

            document.querySelectorAll('.action-button').forEach(btn => {
                if (editMode) {
                    if (!btn.querySelector('.delete-badge')) {
                        const x = document.createElement('div');
                        x.className = 'delete-badge';
                        x.textContent = 'X';
                        x.onclick = x.ontouchstart = e => {
                            e.stopPropagation();
                            if (confirm('Delete this button?')) {
                                const id = btn.dataset.id;
                                buttons = buttons.filter(b => b.id !== id);
                                localStorage.setItem('soundboardButtons', JSON.stringify(buttons));
                                btn.remove();
                            }
                        };
                        btn.appendChild(x);
                        btn.style.animation = 'shake 0.6s';
                        setTimeout(() => btn.style.animation = '', 600);
                    }
                } else {
                    const badge = btn.querySelector('.delete-badge');
                    if (badge) badge.remove();
                }
            });

            alert(editMode ? "EDIT MODE ON\nTap red X to delete" :)" : "Edit mode off");
        };

        function createButton(data) {
            const btn = document.createElement('button');
            btn.className = 'action-button';
            btn.dataset.id = data.id;
            btn.style.backgroundColor = data.color;
            btn.textContent = data.emoticon;

            btn.addEventListener('touchstart', e => {
                if (editMode) { e.preventDefault(); return; }

                holdTimer = setTimeout(() => {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            chunks = [];
                            recorder = new MediaRecorder(stream);
                            recorder.ondataavailable = e => chunks.push(e.data);
                            recorder.onstop = () => {
                                const blob = new Blob(chunks, { type: 'audio/webm' });
                                const reader = new FileReader();
                                reader.onload = () => {
                                    data.audio = reader.result;
                                    localStorage.setItem('soundboardButtons', JSON.stringify(buttons));
                                    alert("Recording saved!");
                                    btn.textContent = data.emoticon;
                                };
                                reader.readAsDataURL(blob);
                                stream.getTracks().forEach(t => t.stop());
                            };
                            recorder.start();
                            btn.classList.add('recording');
                            btn.textContent = 'REC';
                        })
                        .catch(() => alert("Allow microphone access"));
                }, 3000);
            }, { passive: false });

            btn.addEventListener('touchend', () => {
                clearTimeout(holdTimer);
                if (editMode) return;
                if (recorder?.state === 'recording') {
                    recorder.stop();
                    btn.classList.remove('recording');
                } else if (data.audio) {
                    new Audio(data.audio).play();
                }
            });

            container.appendChild(btn);
        }

        // Load all buttons
        buttons.forEach(createButton);

        // Add new button
        addBtn.onclick = () => {
            if (editMode) editBtn.click();
            emoji.value = 'Microphone';
            modal.style.display = 'flex';
        };

        [cancelBtn, modal].forEach(el => el.onclick = e => {
            if (e.target === el) modal.style.display = 'none';
        });

        emoji.onclick = () => {
            emoji.removeAttribute('readonly');
            emoji.focus();
            alert("Now pick any emoji from your keyboard!");
        };

        emoji.onblur = () => {
            const e = [...emoji.value.matchAll(/\p{Emoji}/gu)].slice(0,2).join('') || 'Speaker';
            emoji.value = e;
            emoji.setAttribute('readonly', true);
        };

        saveBtn.onclick = () => {
            const newBtn = {
                id: Date.now() + '',
                color: colorInput.value,
                emoticon: emoji.value || 'Microphone',
                audio: null
            };
            buttons.push(newBtn);
            localStorage.setItem('soundboardButtons', JSON.stringify(buttons));
            createButton(newBtn);
            modal.style.display = 'none';
        };
    </script>
</body>
</html>
